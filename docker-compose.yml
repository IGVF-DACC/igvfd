version: "3.8"

services:

  postgres:
    build:
      context: ./docker/postgres/
    image: igvfd-postgres
    environment:
      POSTGRES_HOST_AUTH_METHOD: trust
    ports:
      - "5432:5432"

  loader:
    build:
      context: .
      dockerfile: ./docker/pyramid/Dockerfile
    image: igvfd-pyramid
    volumes:
      - ".:/igvfd"
      - "/igvfd/src/igvfd.egg-info"
    command: load-development
    depends_on:
      - postgres

  opensearch:
    image: opensearchproject/opensearch:2.2.1
    environment:
      - cluster.name=opensearch-cluster
      - node.name=opensearch-node1
      - bootstrap.memory_lock=true
      - "OPENSEARCH_JAVA_OPTS=-Xms256m -Xmx256m"
      - "DISABLE_INSTALL_DEMO_CONFIG=true"
      - "DISABLE_SECURITY_PLUGIN=true"
      - "discovery.type=single-node"
    ports:
      - "9200:9200"
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536

  pyramid:
    build:
      context: .
      dockerfile: ./docker/pyramid/Dockerfile
    image: igvfd-pyramid
    volumes:
      - ".:/igvfd"
      - "/igvfd/src/igvfd.egg-info"
    command: /scripts/pyramid/run-development.sh
    ports:
      - "6543:6543"
    depends_on:
      - loader

  nginx:
    build:
      context: .
      dockerfile: ./docker/nginx/Dockerfile
    image: igvfd-nginx
    volumes:
      - "./config/nginx/docker.conf:/etc/nginx/nginx.conf"
    command: nginx -c /etc/nginx/nginx.conf -g 'daemon off; pid /dev/null;'
    ports:
      - "8000:8000"
    depends_on:
      - pyramid

  create-mapping:
    build:
      context: .
      dockerfile: ./docker/pyramid/Dockerfile
    image: igvfd-pyramid
    volumes:
      - ".:/igvfd"
      - "/igvfd/src/igvfd.egg-info"
    command: /scripts/pyramid/run-create-mapping.sh
    depends_on:
      - nginx

  indexer:
    build:
      context: .
      dockerfile: ./docker/pyramid/Dockerfile
    image: igvfd-pyramid
    volumes:
      - ".:/igvfd"
      - "/igvfd/src/igvfd.egg-info"
    command: /scripts/pyramid/run-indexer.sh
    ports:
      - "7000:7000"
    depends_on:
      - create-mapping
